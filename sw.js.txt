// sw.js

// ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ: Service Workerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç®¡ç†
self.addEventListener('install', (event) => {
  console.log('Service Worker: Installed');
  // Service WorkerãŒã™ãã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
  self.skipWaiting(); 
});

// ãƒ•ã‚§ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å¿œç­”ã«COOP/COEPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹
self.addEventListener('fetch', (event) => {
  // ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆHTMLã€JSã€CSSã€Workerãªã©ï¼‰ã®å¿œç­”ã‚’å‡¦ç†
  event.respondWith(
    (async () => {
      // 1. é€šå¸¸é€šã‚Šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ•ã‚§ãƒƒãƒ
      const response = await fetch(event.request);
      
      // 2. å¿œç­”ãŒå–å¾—ã§ããªã‹ã£ãŸã‚Šã€ä¸é€æ˜ãªå¿œç­” (opaque response) ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
      if (!response || response.status !== 200 || response.type !== 'basic') {
        return response;
      }

      // 3. å¿œç­”ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã€æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
      const newHeaders = new Headers(response.headers);
      
      // ğŸ’¡ å¿…é ˆãƒ˜ãƒƒãƒ€ãƒ¼: Cross-Origin Isolationã‚’æœ‰åŠ¹åŒ–
      newHeaders.set('Cross-Origin-Opener-Policy', 'same-origin');
      newHeaders.set('Cross-Origin-Embedder-Policy', 'require-corp');

      // 4. æ–°ã—ã„å¿œç­”ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦è¿”ã™
      const newResponse = new Response(response.body, {
        status: response.status,
        statusText: response.statusText,
        headers: newHeaders,
      });

      return newResponse;
    })()
  );
});